name: Multi Tenancy Model Testing
model_file: ./model.fga
tuples:
  # ==============================================================================
  # ORGANISATION A1
  # ==============================================================================

  # --- Organisation A1 Setup ---
  - user: user:A1-owner
    object: organisation:A1
    relation: owner

  # --- Groups for Organisation A1 ---
  # Engineering department parent group
  - user: organisation:A1
    object: group:A1-eng
    relation: organisation

  # Platform group
  - user: organisation:A1
    object: group:A1-platform
    relation: organisation

  # DevOps group
  - user: organisation:A1
    object: group:A1-devops
    relation: organisation

  # Solution group
  - user: organisation:A1
    object: group:A1-solution
    relation: organisation

  # --- Group Hierarchy for A1 (nested groups under engineering) ---
  - user: group:A1-platform#member
    object: group:A1-eng
    relation: member

  - user: group:A1-devops#member
    object: group:A1-eng
    relation: member

  - user: group:A1-solution#member
    object: group:A1-eng
    relation: member

  # --- Platform Team Users (A1) ---
  - user: user:A1-plt-u1
    object: group:A1-platform
    relation: member

  - user: user:A1-plt-u2
    object: group:A1-platform
    relation: member

  - user: user:A1-plt-u3
    object: group:A1-platform
    relation: member

  # --- DevOps Team Users (A1) ---
  - user: user:A1-dev-u1
    object: group:A1-devops
    relation: member

  - user: user:A1-dev-u2
    object: group:A1-devops
    relation: member

  - user: user:A1-dev-u3
    object: group:A1-devops
    relation: member

  # --- Solution Team Users (A1) ---
  - user: user:A1-sol-u1
    object: group:A1-solution
    relation: member

  - user: user:A1-sol-u2
    object: group:A1-solution
    relation: member

  - user: user:A1-sol-u3
    object: group:A1-solution
    relation: member

  # --- Assign Engineering group to Organisation A1 as editors ---
  - user: group:A1-eng#member
    object: organisation:A1
    relation: editor

  # ==============================================================================
  # ORGANISATION A2
  # ==============================================================================

  # --- Organisation A2 Setup ---
  - user: user:A2-owner
    object: organisation:A2
    relation: owner

  # --- Groups for Organisation A2 ---
  # Engineering department parent group
  - user: organisation:A2
    object: group:A2-eng
    relation: organisation

  # Platform group
  - user: organisation:A2
    object: group:A2-platform
    relation: organisation

  # DevOps group
  - user: organisation:A2
    object: group:A2-devops
    relation: organisation

  # Solution group
  - user: organisation:A2
    object: group:A2-solution
    relation: organisation

  # --- Group Hierarchy for A2 (nested groups under engineering) ---
  - user: group:A2-platform#member
    object: group:A2-eng
    relation: member

  - user: group:A2-devops#member
    object: group:A2-eng
    relation: member

  - user: group:A2-solution#member
    object: group:A2-eng
    relation: member

  # --- Platform Team Users (A2) ---
  - user: user:A2-plt-u1
    object: group:A2-platform
    relation: member

  - user: user:A2-plt-u2
    object: group:A2-platform
    relation: member

  - user: user:A2-plt-u3
    object: group:A2-platform
    relation: member

  # --- DevOps Team Users (A2) ---
  - user: user:A2-dev-u1
    object: group:A2-devops
    relation: member

  - user: user:A2-dev-u2
    object: group:A2-devops
    relation: member

  - user: user:A2-dev-u3
    object: group:A2-devops
    relation: member

  # --- Solution Team Users (A2) ---
  - user: user:A2-sol-u1
    object: group:A2-solution
    relation: member

  - user: user:A2-sol-u2
    object: group:A2-solution
    relation: member

  - user: user:A2-sol-u3
    object: group:A2-solution
    relation: member

  # --- Assign Engineering group to Organisation A2 as editors ---
  - user: group:A2-eng#member
    object: organisation:A2
    relation: editor

  # ==============================================================================
  # RESOURCES
  # ==============================================================================

  # --- Resources for Organisation A1 ---
  - user: organisation:A1
    object: resource:A1-api-service
    relation: organisation

  - user: organisation:A1
    object: resource:A1-database
    relation: organisation

  # --- Resources for Organisation A2 ---
  - user: organisation:A2
    object: resource:A2-api-service
    relation: organisation

  - user: organisation:A2
    object: resource:A2-database
    relation: organisation

  # ==============================================================================
  # ACTIONS
  # ==============================================================================

  # --- Actions for A1 resources ---
  - user: action:execute
    object: resource:A1-api-service
    relation: action

  - user: action:proxy
    object: resource:A1-database
    relation: action

  # --- Actions for A2 resources ---
  - user: action:execute
    object: resource:A2-api-service
    relation: action

tests:
  - name: Organisation A1 Tests
    check:
      # --- Owner Tests ---
      - user: user:A1-owner
        object: organisation:A1
        assertions:
          owner: true
          admin: true
          editor: true
          viewer: true

      # --- Group Membership Tests ---
      - user: user:A1-plt-u1
        object: group:A1-platform
        assertions:
          member: true

      - user: user:A1-plt-u1
        object: group:A1-eng
        assertions:
          member: true # via platform group membership

      # --- Organisation Permission Tests via Group ---
      - user: user:A1-plt-u1
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      - user: user:A1-dev-u2
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      - user: user:A1-sol-u3
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      # --- Resource Access Tests (A1 users on A1 resources) ---
      - user: user:A1-plt-u1
        object: resource:A1-api-service
        assertions:
          can_edit: true
          can_view: true
          editor: true

      - user: user:A1-dev-u2
        object: resource:A1-database
        assertions:
          can_edit: true
          can_view: true

      # --- Action Permission Tests ---
      - user: user:A1-plt-u1
        object: resource:A1-api-service
        assertions:
          can_perform_action: true # editor can perform actions

  - name: Organisation A2 Tests
    check:
      # --- Owner Tests ---
      - user: user:A2-owner
        object: organisation:A2
        assertions:
          owner: true
          admin: true

      # --- Group Membership Tests ---
      - user: user:A2-dev-u1
        object: group:A2-devops
        assertions:
          member: true

      - user: user:A2-dev-u1
        object: group:A2-eng
        assertions:
          member: true # via devops group membership

      # --- Resource Access Tests (A2 users on A2 resources) ---
      - user: user:A2-plt-u2
        object: resource:A2-api-service
        assertions:
          can_edit: true
          can_view: true

      - user: user:A2-sol-u3
        object: resource:A2-database
        assertions:
          can_edit: true
          can_view: true

  - name: Multi-Tenancy Isolation Tests
    check:
      # --- Cross-Org Access Denial Tests ---
      # A1 users should NOT have access to A2 resources
      - user: user:A1-plt-u1
        object: organisation:A2
        assertions:
          owner: false
          admin: false
          editor: false
          viewer: false

      - user: user:A1-plt-u1
        object: resource:A2-api-service
        assertions:
          can_edit: false
          can_view: false

      - user: user:A1-dev-u2
        object: resource:A2-database
        assertions:
          can_edit: false
          can_view: false

      # A2 users should NOT have access to A1 resources
      - user: user:A2-plt-u1
        object: organisation:A1
        assertions:
          owner: false
          admin: false
          editor: false
          viewer: false

      - user: user:A2-dev-u1
        object: resource:A1-api-service
        assertions:
          can_edit: false
          can_view: false

      - user: user:A2-sol-u2
        object: resource:A1-database
        assertions:
          can_edit: false
          can_view: false

  - name: Group Hierarchy Tests
    check:
      # --- Nested Group Membership ---
      # Platform team members should be part of engineering group
      - user: user:A1-plt-u1
        object: group:A1-eng
        assertions:
          member: true

      - user: user:A1-plt-u2
        object: group:A1-eng
        assertions:
          member: true

      # DevOps team members should be part of engineering group
      - user: user:A1-dev-u1
        object: group:A1-eng
        assertions:
          member: true

      # Solution team members should be part of engineering group
      - user: user:A1-sol-u1
        object: group:A1-eng
        assertions:
          member: true

      # Same for A2
      - user: user:A2-plt-u3
        object: group:A2-eng
        assertions:
          member: true

      - user: user:A2-dev-u3
        object: group:A2-eng
        assertions:
          member: true

      - user: user:A2-sol-u3
        object: group:A2-eng
        assertions:
          member: true
