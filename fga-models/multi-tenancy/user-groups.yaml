name: User Groups and Organisation Testing
model_file: ./model.fga

# Import organisations, users, and groups
tuple_files:
  - ./tuples-org-users-groups.yaml
  - ./tuples-resources.yaml

tests:
  - name: Organisation A1 Tests
    check:
      # --- Owner Tests ---
      - user: user:A1-owner
        object: organisation:A1
        assertions:
          owner: true
          admin: true
          editor: true
          viewer: true

      # --- Group Membership Tests ---
      - user: user:A1-plt-u1
        object: group:A1-platform
        assertions:
          member: true

      - user: user:A1-plt-u1
        object: group:A1-eng
        assertions:
          member: true # via platform group membership

      # --- Organisation Permission Tests via Group ---
      - user: user:A1-plt-u1
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      - user: user:A1-dev-u2
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      - user: user:A1-sol-u3
        object: organisation:A1
        assertions:
          editor: true
          viewer: true

      # --- Resource Access Tests (A1 users on A1 resources) ---
      - user: user:A1-plt-u1
        object: resource:A1-api-service
        assertions:
          can_update: true
          can_get: true
          can_list: true
          editor: true

      - user: user:A1-dev-u2
        object: resource:A1-database
        assertions:
          can_update: true
          can_get: true
          can_list: true

  - name: Organisation A2 Tests
    check:
      # --- Owner Tests ---
      - user: user:A2-owner
        object: organisation:A2
        assertions:
          owner: true
          admin: true

      # --- Group Membership Tests ---
      - user: user:A2-dev-u1
        object: group:A2-devops
        assertions:
          member: true

      - user: user:A2-dev-u1
        object: group:A2-eng
        assertions:
          member: true # via devops group membership

      # --- Resource Access Tests (A2 users on A2 resources) ---
      - user: user:A2-plt-u2
        object: resource:A2-api-service
        assertions:
          can_update: true
          can_get: true
          can_list: true

      - user: user:A2-sol-u3
        object: resource:A2-database
        assertions:
          can_update: true
          can_get: true
          can_list: true

  - name: Multi-Tenancy Isolation Tests
    check:
      # --- Cross-Org Access Denial Tests ---
      # A1 users should NOT have access to A2 resources
      - user: user:A1-plt-u1
        object: organisation:A2
        assertions:
          owner: false
          admin: false
          editor: false
          viewer: false

      - user: user:A1-plt-u1
        object: resource:A2-api-service
        assertions:
          can_update: false
          can_get: false
          can_list: false

      - user: user:A1-dev-u2
        object: resource:A2-database
        assertions:
          can_update: false
          can_get: false
          can_list: false

      # A2 users should NOT have access to A1 resources
      - user: user:A2-plt-u1
        object: organisation:A1
        assertions:
          owner: false
          admin: false
          editor: false
          viewer: false

      - user: user:A2-dev-u1
        object: resource:A1-api-service
        assertions:
          can_update: false
          can_get: false
          can_list: false

      - user: user:A2-sol-u2
        object: resource:A1-database
        assertions:
          can_update: false
          can_get: false
          can_list: false

  - name: Group Hierarchy Tests
    check:
      # --- Nested Group Membership ---
      # Platform team members should be part of engineering group
      - user: user:A1-plt-u1
        object: group:A1-eng
        assertions:
          member: true

      - user: user:A1-plt-u2
        object: group:A1-eng
        assertions:
          member: true

      # DevOps team members should be part of engineering group
      - user: user:A1-dev-u1
        object: group:A1-eng
        assertions:
          member: true

      # Solution team members should be part of engineering group
      - user: user:A1-sol-u1
        object: group:A1-eng
        assertions:
          member: true

      # Same for A2
      - user: user:A2-plt-u3
        object: group:A2-eng
        assertions:
          member: true

      - user: user:A2-dev-u3
        object: group:A2-eng
        assertions:
          member: true

      - user: user:A2-sol-u3
        object: group:A2-eng
        assertions:
          member: true
